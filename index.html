<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÎšÎ•Î”Î•Î•Î‘ â€“ Booking Calendar</title>

  <style>
    :root{
      color-scheme: light;
      --bg:#f5f7fb;
      --card:#ffffff;
      --primary:#2b59c3;
      --primary-dark:#1e3f8c;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e2e8f0;
      --accent:#f97316;
      --danger:#dc2626;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    html, body { overflow-x: hidden; } /* FIX overflow Î´ÎµÎ¾Î¹Î¬ */

    body{
      margin:0;
      font-family:"Inter","Segoe UI",system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:linear-gradient(120deg,#1d4ed8,#4338ca);
      color:#fff;
      padding:28px 20px;
    }
    header h1{margin:0 0 6px;font-size:26px}
    header p{margin:0;opacity:.9}

    main{
      max-width:1100px;
      margin:18px auto 40px;
      padding:0 20px;
      display:grid;
      gap:20px;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); /* FIX responsive */
    }
    @media (max-width: 600px){
      main{ grid-template-columns: 1fr; padding: 0 12px; }
    }

    .card{
      background:var(--card);
      border-radius:18px;
      padding:20px;
      box-shadow:0 16px 30px rgba(15,23,42,.08);
      border:1px solid var(--border);
      min-width:0; /* FIX: ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ shrink Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ grid */
    }
    .card h2{margin:0 0 8px;font-size:20px}

    label{display:block;margin-top:12px;font-weight:600}
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      margin-top:6px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
    }

    button{
      margin-top:16px;
      padding:12px 16px;
      border:none;
      border-radius:12px;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      transition:transform .2s ease, background .2s ease;
    }
    button:hover{background:var(--primary-dark);transform:translateY(-1px)}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .grid-2{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .status{margin-top:12px;font-weight:800}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}

    .privacy{
      background:rgba(15,23,42,.04);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      color:var(--muted);
      margin-top:10px;
    }

    .calendar-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .calendar-header .nav{display:flex;gap:8px;flex-wrap:wrap}
    .calendar-header .nav button{
      margin:0;
      background:transparent;
      color:var(--primary);
      border:1px solid var(--border);
      padding:6px 10px;
    }

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      text-align:center;
      font-size:13px;
      width:100%;
      min-width:0; /* FIX */
    }
    .calendar-cell{
      padding:10px 6px;
      border-radius:10px;
      border:1px solid transparent;
      background:#f8fafc;
      min-height:58px;
      cursor:pointer;
      user-select:none;
      overflow:hidden; /* FIX */
    }
    .calendar-cell.header{
      background:transparent;
      border:none;
      cursor:default;
      font-weight:900;
      min-height:auto;
      padding:6px 0;
    }
    .calendar-cell.empty{
      background:transparent;
      border:none;
      cursor:default;
    }
    .calendar-cell.active{
      border-color:var(--primary);
      background:rgba(43,89,195,.12);
    }
    .calendar-cell.has-booking{
      background:rgba(249,115,22,.12);
      border-color:rgba(249,115,22,.3);
    }
    .calendar-cell span{
      display:block;
      font-weight:800;
      margin-bottom:4px;
    }

    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(43,89,195,.1);
      color:var(--primary);
      font-size:12px;
      font-weight:800;
      max-width:100%;
      white-space:nowrap;
    }

    .booking-list{display:grid;gap:12px;margin-top:12px}
    .booking-item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      background:#fff;
    }
    .booking-item h3{margin:0 0 6px;font-size:16px}
    .booking-meta{display:grid;gap:4px;font-size:13px;color:var(--muted)}

    .booking-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn-small{
      margin:0;
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:800;
    }
    .btn-small:hover{transform:none}
    .btn-edit{border-color:rgba(43,89,195,.35); color:var(--primary)}
    .btn-del{border-color:rgba(220,38,38,.35); color:var(--danger)}
  </style>
</head>

<body>
  <header>
    <h1>ÎšÎ•Î”Î•Î•Î‘ â€“ Booking Calendar</h1>
    <p>ÎšÎ¿Î¹Î½ÏŒ Î·Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿ Î³Î¹Î± ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ ÎºÎ»Î¹Î½Î¹ÎºÎ¿ÏÏ‚ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î­Ï‚, Ï‡Ï‰ÏÎ¯Ï‚ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î­Ï‚ email.</p>
  </header>

  <main>
    <section class="card">
      <h2>Î ÏÏŒÏƒÎ²Î±ÏƒÎ·</h2>

      <label for="accessToken">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚</label>
      <input id="accessToken" type="password" placeholder="Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ" autocomplete="current-password" />

      <div class="hint">ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î® ÎºÎ±Î¹ ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.</div>
      <div class="privacy">
        Î¤Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎ¿Î½Ï„Î±Î¹ Î¼Îµ Î¹Î´Î¹Ï‰Ï„Î¹ÎºÏŒ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚. ÎœÎ¿Î¹ÏÎ¬ÏƒÏ„Îµ Ï„Î¿Î½ Î¼ÏŒÎ½Î¿ Î¼Îµ Ï„Î¿Ï…Ï‚ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î·Î¼Î­Î½Î¿Ï…Ï‚ ÎºÎ»Î¹Î½Î¹ÎºÎ¿ÏÏ‚ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î­Ï‚.
      </div>

      <button type="button" id="refreshBtn">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· / Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
      <div class="status" id="authStatus"></div>
    </section>

    <section class="card">
      <h2>ÎÎ­Î± ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·</h2>

      <form id="bookingForm">
        <label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿ Ï‰Ï†ÎµÎ»Î¿ÏÎ¼ÎµÎ½Î¿Ï…</label>
        <input name="beneficiaryName" required />

        <div class="grid-2">
          <div>
            <label>Email Ï‰Ï†ÎµÎ»Î¿ÏÎ¼ÎµÎ½Î¿Ï…</label>
            <input name="beneficiaryEmail" type="email" required />
          </div>
          <div>
            <label>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿ Ï‰Ï†ÎµÎ»Î¿ÏÎ¼ÎµÎ½Î¿Ï…</label>
            <input name="beneficiaryPhone" type="tel" required />
          </div>
        </div>

        <label>Î•Î¯Î´Î¿Ï‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚</label>
        <select name="serviceType" required>
          <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±</option>
          <option>Î£Ï…Î¼Î²Î¿Ï…Î»ÎµÏ…Ï„Î¹ÎºÎ®</option>
          <option>Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·</option>
          <option>Î Î±ÏÎ­Î¼Î²Î±ÏƒÎ·</option>
          <option>Î†Î»Î»Î¿</option>
        </select>

        <div class="grid-2">
          <div>
            <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
            <input name="date" type="date" required />
          </div>
          <div>
            <label>ÎÏÎ±</label>
            <input name="time" type="time" required />
            <div class="hint">ÎœÎ¿ÏÏ†Î®: 24Ï‰ÏÎ¿ (Ï€.Ï‡. 09:30, 16:15)</div>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label>Î‘Î¯Î¸Î¿Ï…ÏƒÎ±</label>
            <input name="room" required />
          </div>
          <div>
            <label>ÎšÎ»Î¹Î½Î¹ÎºÏŒÏ‚ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î®Ï‚</label>
            <input name="clinician" required />
          </div>
        </div>

        <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
        <textarea name="notes" rows="3" placeholder="Î .Ï‡. ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚"></textarea>

        <button type="submit" id="saveBtn">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·</button>
        <div class="status" id="formStatus"></div>
      </form>
    </section>

    <section class="card">
      <div class="calendar-header">
        <h2>Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿</h2>
        <div class="nav">
          <button type="button" id="prevMonth">â—€</button>
          <button type="button" id="nextMonth">â–¶</button>
        </div>
      </div>

      <div class="hint" id="monthLabel"></div>
      <div class="calendar-grid" id="calendarGrid"></div>
      <div class="booking-list" id="bookingList"></div>
    </section>
  </main>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYrJR-YjFahtcPheLFFw3s9ZNBc5wIpC4Aq-suTCu83F0agpGFyVvJ-L52SYZnyYK4/exec";

    const accessTokenInput = document.getElementById("accessToken");
    const authStatus = document.getElementById("authStatus");
    const refreshBtn = document.getElementById("refreshBtn");

    const bookingForm = document.getElementById("bookingForm");
    const formStatus = document.getElementById("formStatus");
    const saveBtn = document.getElementById("saveBtn");

    const calendarGrid = document.getElementById("calendarGrid");
    const bookingList = document.getElementById("bookingList");
    const monthLabel = document.getElementById("monthLabel");
    const prevMonth = document.getElementById("prevMonth");
    const nextMonth = document.getElementById("nextMonth");

    let bookings = [];
    let currentMonth = new Date();
    let selectedDate = null;

    // persist token in sessionStorage
    accessTokenInput.value = sessionStorage.getItem("accessToken") || "";
    accessTokenInput.addEventListener("input", () => {
      sessionStorage.setItem("accessToken", accessTokenInput.value.trim());
    });

    function setStatus(el, msg, kind) {
      el.textContent = msg || "";
      el.classList.remove("ok", "err");
      if (kind === "ok") el.classList.add("ok");
      if (kind === "err") el.classList.add("err");
    }

    function token() {
      return accessTokenInput.value.trim();
    }

    // ---------- Timezone: Athens + 24h normalization ----------
    const TZ = "Europe/Athens";

    function partsInAthens(dateObj) {
      const dtf = new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
      const parts = dtf.formatToParts(dateObj);
      const get = (type) => parts.find(p => p.type === type)?.value || "";
      return { y: get("year"), m: get("month"), d: get("day"), hh: get("hour"), mm: get("minute") };
    }

    function toDateKey(v) {
      if (!v) return "";
      const s = String(v);

      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      const d = new Date(s);
      if (!isNaN(d.getTime())) {
        const p = partsInAthens(d);
        return `${p.y}-${p.m}-${p.d}`;
      }
      return "";
    }

    function toTimeHHMM(v) {
      if (!v) return "";
      const s = String(v);

      if (/^\d{2}:\d{2}$/.test(s)) return s;

      const d = new Date(s);
      if (!isNaN(d.getTime())) {
        const p = partsInAthens(d);
        return `${p.hh}:${p.mm}`;
      }
      return s.slice(0, 5);
    }

    function normalizeBookings(arr) {
      return (arr || []).map(b => ({
        ...b,
        id: b.id != null ? String(b.id) : "",
        date: toDateKey(b.date),
        time: toTimeHHMM(b.time),
        beneficiaryPhone: b.beneficiaryPhone != null ? String(b.beneficiaryPhone) : ""
      }));
    }
    // ---------------------------------------------------------

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const u = new URL(url);
        u.searchParams.set("callback", cb);

        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };

        const script = document.createElement("script");
        script.src = u.toString();
        script.onerror = () => {
          delete window[cb];
          script.remove();
          reject(new Error("JSONP load failed"));
        };
        document.body.appendChild(script);
      });
    }

    async function apiCall(action, params = {}) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", action);
      Object.entries(params).forEach(([k, v]) => u.searchParams.set(k, v ?? ""));
      return await jsonp(u.toString());
    }

    async function loadBookings() {
      setStatus(authStatus, "Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦", null);

      try {
        const res = await apiCall("list");
        if (!res?.ok) {
          bookings = [];
          renderCalendar();
          setStatus(authStatus, "âŒ ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Î® ÏƒÏ†Î¬Î»Î¼Î±.", "err");
          return;
        }

        bookings = normalizeBookings(res.data);
        setStatus(authStatus, "âœ… Î ÏÏŒÏƒÎ²Î±ÏƒÎ· ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÎ¸Î·ÎºÎµ. Î¤Î¿ Î·Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ.", "ok");
        renderCalendar();
      } catch (e) {
        bookings = [];
        renderCalendar();
        setStatus(authStatus, "âš ï¸ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ (JSONP).", "err");
        console.error(e);
      }
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      const firstDay = new Date(year, month, 1);
      const startDay = (firstDay.getDay() + 6) % 7;
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      monthLabel.textContent = firstDay.toLocaleDateString("el-GR", { month: "long", year: "numeric" });
      calendarGrid.innerHTML = "";

      const dayLabels = ["Î”", "Î¤", "Î¤", "Î ", "Î ", "Î£", "Îš"];
      dayLabels.forEach((label) => {
        const cell = document.createElement("div");
        cell.className = "calendar-cell header";
        cell.textContent = label;
        calendarGrid.appendChild(cell);
      });

      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement("div");
        empty.className = "calendar-cell empty";
        calendarGrid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        const dateKey = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        const dayBookings = bookings.filter((b) => b.date === dateKey);

        cell.className = "calendar-cell";
        if (dayBookings.length) cell.classList.add("has-booking");
        if (selectedDate === dateKey) cell.classList.add("active");

        cell.innerHTML =
          `<span>${day}</span>` +
          (dayBookings.length ? `<div class="badge">${dayBookings.length} ÏÎ±Î½Ï„ÎµÎ²Î¿Ï</div>` : "");

        cell.addEventListener("click", () => {
          selectedDate = dateKey;
          renderCalendar();
          renderBookingsForDate(dateKey);

          const dateInput = bookingForm.querySelector('input[name="date"]');
          if (dateInput) dateInput.value = dateKey;
        });

        calendarGrid.appendChild(cell);
      }

      if (selectedDate) renderBookingsForDate(selectedDate);
      else bookingList.innerHTML = `<div class="hint">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î·Î¼Î­ÏÎ± Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î¹Ï‚ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚.</div>`;
    }

    function renderBookingsForDate(dateKey) {
      const dayBookings = bookings
        .filter((b) => b.date === dateKey)
        .sort((a, b) => String(a.time).localeCompare(String(b.time)));

      if (!dayBookings.length) {
        bookingList.innerHTML = `<div class="hint">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î·Î¼Î­ÏÎ±.</div>`;
        return;
      }

      bookingList.innerHTML = dayBookings.map((b) => `
        <div class="booking-item">
          <h3>${escapeHtml(b.time)} Â· ${escapeHtml(b.beneficiaryName)}</h3>
          <div class="booking-meta">
            <div><b>ID:</b> ${escapeHtml(b.id)}</div>
            <div>Î¥Ï€Î·ÏÎµÏƒÎ¯Î±: ${escapeHtml(b.serviceType)}</div>
            <div>Î‘Î¯Î¸Î¿Ï…ÏƒÎ±: ${escapeHtml(b.room)}</div>
            <div>ÎšÎ»Î¹Î½Î¹ÎºÏŒÏ‚ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î®Ï‚: ${escapeHtml(b.clinician)}</div>
            <div>Email: ${escapeHtml(b.beneficiaryEmail)}</div>
            <div>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿: ${escapeHtml(b.beneficiaryPhone)}</div>
            ${b.notes ? `<div>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚: ${escapeHtml(b.notes)}</div>` : ""}
          </div>

          <div class="booking-actions">
            <button class="btn-small btn-edit" type="button" onclick="editBooking('${escapeHtml(b.id)}')">âœï¸ Î‘Î»Î»Î±Î³Î® ÏÏÎ±Ï‚/Î·Î¼.</button>
            <button class="btn-small btn-del" type="button" onclick="deleteBooking('${escapeHtml(b.id)}')">ğŸ—‘ Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
          </div>
        </div>
      `).join("");
    }

    // --- Edit/Delete exposed to window for inline onclick ---
    window.deleteBooking = async function(id) {
      if (!id) return alert("Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ id.");
      const ok = confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏÎ±Î½Ï„ÎµÎ²Î¿Ï Î¼Îµ id: ${id} ;`);
      if (!ok) return;

      try {
        const res = await apiCall("delete", { id });
        if (!res?.ok) return alert(res?.error || "Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚.");
        await loadBookings();
      } catch (e) {
        console.error(e);
        alert("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ (JSONP).");
      }
    };

    window.editBooking = async function(id) {
      if (!id) return alert("Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ id.");
      const b = bookings.find(x => String(x.id) === String(id));
      if (!b) return alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ ÏÎ±Î½Ï„ÎµÎ²Î¿Ï.");

      const newDate = prompt("ÎÎ­Î± Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± (YYYY-MM-DD) Î® Enter Î³Î¹Î± Î½Î± Î¼ÎµÎ¯Î½ÎµÎ¹ Î¯Î´Î¹Î±:", b.date || "");
      if (newDate === null) return; // cancel
      const dateVal = (newDate || b.date || "").trim();
      if (dateVal && !/^\d{4}-\d{2}-\d{2}$/.test(dateVal)) return alert("Î›Î¬Î¸Î¿Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±. Î˜Î­Î»Ï‰ YYYY-MM-DD.");

      const newTime = prompt("ÎÎ­Î± ÏÏÎ± (HH:MM) Î® Enter Î³Î¹Î± Î½Î± Î¼ÎµÎ¯Î½ÎµÎ¹ Î¯Î´Î¹Î±:", b.time || "");
      if (newTime === null) return; // cancel
      const timeVal = (newTime || b.time || "").trim();
      if (timeVal && !/^\d{2}:\d{2}$/.test(timeVal)) return alert("Î›Î¬Î¸Î¿Ï‚ ÏÏÎ±. Î˜Î­Î»Ï‰ HH:MM (24Ï‰ÏÎ¿).");

      // Î‘Î½ Î´ÎµÎ½ Î¬Î»Î»Î±Î¾Îµ Ï„Î¯Ï€Î¿Ï„Î±, Ï†ÏÎ³Îµ
      if (dateVal === b.date && timeVal === b.time) return;

      try {
        const res = await apiCall("update", { id, date: dateVal, time: timeVal });
        if (!res?.ok) return alert(res?.error || "Î£Ï†Î¬Î»Î¼Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚.");
        await loadBookings();
        // ÎºÏÎ±Ï„Î¬Î¼Îµ Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ Î· Î·Î¼Î­ÏÎ± Ï€Î¿Ï… ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ
        selectedDate = dateVal || selectedDate;
        renderCalendar();
      } catch (e) {
        console.error(e);
        alert("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚ (JSONP).");
      }
    };

    // --- Create (add) ---
    bookingForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus(formStatus, "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·â€¦", null);
      saveBtn.disabled = true;

      const data = Object.fromEntries(new FormData(event.target).entries());

      // enforce formats
      const d = String(data.date || "").trim();
      const t = String(data.time || "").trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(d)) {
        setStatus(formStatus, "âŒ Î›Î¬Î¸Î¿Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±.", "err");
        saveBtn.disabled = false;
        return;
      }
      if (!/^\d{2}:\d{2}$/.test(t)) {
        setStatus(formStatus, "âŒ Î›Î¬Î¸Î¿Ï‚ ÏÏÎ± (HH:MM).", "err");
        saveBtn.disabled = false;
        return;
      }

      try {
        const res = await apiCall("add", data);
        if (!res?.ok) {
          setStatus(formStatus, `âŒ ${res?.error || "Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚"}`, "err");
          return;
        }

        setStatus(formStatus, "âœ… Î— ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.", "ok");
        event.target.reset();

        await loadBookings();
      } catch (e) {
        setStatus(formStatus, "âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·Ï‚ (JSONP).", "err");
        console.error(e);
      } finally {
        saveBtn.disabled = false;
      }
    });

    prevMonth.addEventListener("click", () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
    });

    nextMonth.addEventListener("click", () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
    });

    refreshBtn.addEventListener("click", loadBookings);

    // initial
    loadBookings();
  </script>
</body>
</html>