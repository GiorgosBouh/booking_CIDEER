<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ΚΕΔΕΕΑ – Booking Calendar</title>

  <style>
    :root{
      color-scheme: light;
      --bg:#f5f7fb;
      --card:#ffffff;
      --primary:#2b59c3;
      --primary-dark:#1e3f8c;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e2e8f0;
      --accent:#f97316;
      --danger:#dc2626;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Inter","Segoe UI",system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:linear-gradient(120deg,#1d4ed8,#4338ca);
      color:#fff;
      padding:28px 20px;
    }
    header h1{margin:0 0 6px;font-size:26px}
    header p{margin:0;opacity:.9}

    main{
      max-width:1100px;
      margin:18px auto 40px;
      padding:0 20px;
      display:grid;
      gap:20px;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      align-items:start;
    }
    /* κρίσιμο: να μη “σπάει” grid item και να μην ξεχειλώνει */
    main > * { min-width: 0; }

    .card{
      background:var(--card);
      border-radius:18px;
      padding:20px;
      box-shadow:0 16px 30px rgba(15,23,42,.08);
      border:1px solid var(--border);
      overflow:hidden; /* FIX: να μη βγαίνει δεξιά */
    }
    .card h2{margin:0 0 8px;font-size:20px}

    label{display:block;margin-top:12px;font-weight:600}
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      margin-top:6px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
    }

    button{
      margin-top:16px;
      padding:12px 16px;
      border:none;
      border-radius:12px;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      transition:transform .2s ease, background .2s ease;
    }
    button:hover{background:var(--primary-dark);transform:translateY(-1px)}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .btn-outline{
      background:transparent;
      color:var(--primary);
      border:1px solid var(--border);
      padding:10px 12px;
    }
    .btn-danger{
      background:var(--danger);
    }
    .btn-danger:hover{ background:#b91c1c; }

    .grid-2{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .status{margin-top:12px;font-weight:800}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}

    .privacy{
      background:rgba(15,23,42,.04);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      color:var(--muted);
      margin-top:10px;
    }

    .calendar-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .calendar-header .nav{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .calendar-header .nav button{
      margin:0;
      background:transparent;
      color:var(--primary);
      border:1px solid var(--border);
      padding:6px 10px;
    }

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr)); /* FIX: να χωράει πάντα */
      gap:6px;
      text-align:center;
      font-size:13px;
      width:100%;
      max-width:100%;
    }
    .calendar-cell{
      padding:10px 6px;
      border-radius:10px;
      border:1px solid transparent;
      background:#f8fafc;
      min-height:58px;
      cursor:pointer;
      user-select:none;
      min-width:0;
    }
    .calendar-cell.header{
      background:transparent;
      border:none;
      cursor:default;
      font-weight:900;
      min-height:auto;
      padding:6px 0;
    }
    .calendar-cell.empty{
      background:transparent;
      border:none;
      cursor:default;
    }
    .calendar-cell.active{
      border-color:var(--primary);
      background:rgba(43,89,195,.12);
    }
    .calendar-cell.has-booking{
      background:rgba(249,115,22,.12);
      border-color:rgba(249,115,22,.3);
    }
    .calendar-cell span{
      display:block;
      font-weight:800;
      margin-bottom:4px;
      font-variant-numeric: tabular-nums;
    }

    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(43,89,195,.1);
      color:var(--primary);
      font-size:12px;
      font-weight:800;
      max-width:100%;
      white-space:nowrap;
    }

    .booking-list{display:grid;gap:12px;margin-top:12px}
    .booking-item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      background:#fff;
    }
    .booking-item h3{
      margin:0 0 6px;
      font-size:16px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .booking-meta{display:grid;gap:4px;font-size:13px;color:var(--muted)}
    .row-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .small{
      margin-top:0;
      padding:8px 10px;
      border-radius:10px;
      font-weight:800;
      font-size:13px;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 24px 60px rgba(15,23,42,.22);
      padding:16px;
    }
    .modal h3{ margin:0 0 10px; }
    .modal .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:14px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <header>
    <h1>ΚΕΔΕΕΑ – Booking Calendar</h1>
    <p>Κοινό ημερολόγιο για όλους τους κλινικούς εκπαιδευτές.</p>
  </header>

  <main>
    <section class="card">
      <h2>Πρόσβαση</h2>

      <label for="accessToken">Κωδικός πρόσβασης</label>
      <input id="accessToken" type="password" placeholder="Εισάγετε τον κωδικό" autocomplete="current-password" />

      <div class="hint">Ο κωδικός απαιτείται για προβολή/καταχώρηση. (Π.χ. <b>ciderr_bouch</b>)</div>
      <div class="privacy">
        Τα στοιχεία προστατεύονται με ιδιωτικό κωδικό πρόσβασης. Μοιράστε τον μόνο με τους εξουσιοδοτημένους κλινικούς εκπαιδευτές.
      </div>

      <button type="button" id="refreshBtn">Φόρτωση / Ανανέωση</button>
      <div class="status" id="authStatus"></div>
    </section>

    <section class="card">
      <h2>Νέα καταχώρηση</h2>

      <form id="bookingForm">
        <label>Ονοματεπώνυμο ωφελούμενου</label>
        <input name="beneficiaryName" required />

        <div class="grid-2">
          <div>
            <label>Email ωφελούμενου</label>
            <input name="beneficiaryEmail" type="email" required />
          </div>
          <div>
            <label>Τηλέφωνο ωφελούμενου</label>
            <input name="beneficiaryPhone" type="tel" required />
          </div>
        </div>

        <label>Είδος υπηρεσίας</label>
        <select name="serviceType" required>
          <option value="">Επιλέξτε υπηρεσία</option>
          <option>Συμβουλευτική</option>
          <option>Αξιολόγηση</option>
          <option>Παρέμβαση</option>
          <option>Άλλο</option>
        </select>

        <div class="grid-2">
          <div>
            <label>Ημερομηνία</label>
            <input name="date" type="date" required />
          </div>
          <div>
            <label>Ώρα (24ωρη)</label>
            <input name="time" type="time" required />
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label>Αίθουσα</label>
            <input name="room" required />
          </div>
          <div>
            <label>Κλινικός εκπαιδευτής</label>
            <input name="clinician" required />
          </div>
        </div>

        <label>Σημειώσεις (προαιρετικό)</label>
        <textarea name="notes" rows="3" placeholder="Π.χ. επιπλέον πληροφορίες"></textarea>

        <button type="submit" id="saveBtn">Καταχώρηση</button>
        <div class="status" id="formStatus"></div>
      </form>
    </section>

    <section class="card">
      <div class="calendar-header">
        <div>
          <h2 style="margin:0">Ημερολόγιο</h2>
          <div class="hint" id="monthLabel" style="margin-top:6px"></div>
        </div>
        <div class="nav">
          <button type="button" id="prevMonth">◀</button>
          <button type="button" id="nextMonth">▶</button>
        </div>
      </div>

      <div class="calendar-grid" id="calendarGrid"></div>
      <div class="booking-list" id="bookingList"></div>
    </section>
  </main>

  <!-- Modal for edit -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3>Επεξεργασία ραντεβού</h3>
      <div class="hint" id="modalInfo"></div>

      <div class="grid-2" style="margin-top:10px">
        <div>
          <label>Ημερομηνία</label>
          <input id="editDate" type="date" />
        </div>
        <div>
          <label>Ώρα (24ωρη)</label>
          <input id="editTime" type="time" />
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-outline" id="modalCancel">Άκυρο</button>
        <button type="button" id="modalSave">Αποθήκευση αλλαγής</button>
      </div>

      <div class="status" id="modalStatus"></div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYrJR-YjFahtcPheLFFw3s9ZNBc5wIpC4Aq-suTCu83F0agpGFyVvJ-L52SYZnyYK4/exec";
    const TZ = "Europe/Athens";

    const accessTokenInput = document.getElementById("accessToken");
    const authStatus = document.getElementById("authStatus");
    const refreshBtn = document.getElementById("refreshBtn");

    const bookingForm = document.getElementById("bookingForm");
    const formStatus = document.getElementById("formStatus");
    const saveBtn = document.getElementById("saveBtn");

    const calendarGrid = document.getElementById("calendarGrid");
    const bookingList = document.getElementById("bookingList");
    const monthLabel = document.getElementById("monthLabel");
    const prevMonth = document.getElementById("prevMonth");
    const nextMonth = document.getElementById("nextMonth");

    // modal
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalCancel = document.getElementById("modalCancel");
    const modalSave = document.getElementById("modalSave");
    const modalStatus = document.getElementById("modalStatus");
    const modalInfo = document.getElementById("modalInfo");
    const editDate = document.getElementById("editDate");
    const editTime = document.getElementById("editTime");

    let bookings = [];
    let currentMonth = new Date();
    let selectedDate = null;

    // current edit state
    let editingId = null;

    // persist token in sessionStorage
    accessTokenInput.value = sessionStorage.getItem("accessToken") || "";
    accessTokenInput.addEventListener("input", () => {
      sessionStorage.setItem("accessToken", accessTokenInput.value.trim());
    });

    function setStatus(el, msg, kind) {
      el.textContent = msg || "";
      el.classList.remove("ok", "err");
      if (kind === "ok") el.classList.add("ok");
      if (kind === "err") el.classList.add("err");
    }

    function token() {
      return accessTokenInput.value.trim();
    }

    // ---------- Timezone-safe normalize (Athens, 24h) ----------
    function partsInAthens(dateObj) {
      const dtf = new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
      const parts = dtf.formatToParts(dateObj);
      const get = (type) => parts.find(p => p.type === type)?.value || "";
      return { y:get("year"), m:get("month"), d:get("day"), hh:get("hour"), mm:get("minute") };
    }

    function toDateKey(v) {
      if (!v) return "";
      const s = String(v).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(s);
      if (!isNaN(d.getTime())) {
        const p = partsInAthens(d);
        return `${p.y}-${p.m}-${p.d}`;
      }
      return "";
    }

    function toTimeHHMM(v) {
      if (!v) return "";
      const s = String(v).trim();
      if (/^\d{2}:\d{2}$/.test(s)) return s;
      const d = new Date(s);
      if (!isNaN(d.getTime())) {
        const p = partsInAthens(d);
        return `${p.hh}:${p.mm}`;
      }
      return s.slice(0,5);
    }

    function normalizeBookings(arr) {
      return (arr || []).map(b => ({
        ...b,
        id: String(b.id ?? "").trim(),
        date: toDateKey(b.date),
        time: toTimeHHMM(b.time),
        beneficiaryPhone: b.beneficiaryPhone != null ? String(b.beneficiaryPhone) : ""
      }));
    }
    // ----------------------------------------------------------

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const u = new URL(url);
        u.searchParams.set("callback", cb);

        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };

        const script = document.createElement("script");
        script.src = u.toString();
        script.onerror = () => {
          delete window[cb];
          script.remove();
          reject(new Error("JSONP load failed"));
        };
        document.body.appendChild(script);
      });
    }

    async function loadBookings() {
      setStatus(authStatus, "Φόρτωση…", null);

      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "list");

      try {
        const res = await jsonp(u.toString());
        if (!res?.ok) {
          bookings = [];
          renderCalendar();
          setStatus(authStatus, "❌ Μη έγκυρος κωδικός ή σφάλμα.", "err");
          return;
        }
        bookings = normalizeBookings(res.data);
        setStatus(authStatus, "✅ Πρόσβαση επιβεβαιώθηκε. Το ημερολόγιο φορτώθηκε.", "ok");
        renderCalendar();
      } catch (e) {
        bookings = [];
        renderCalendar();
        setStatus(authStatus, "⚠️ Δεν ήταν δυνατή η φόρτωση (δες Console).", "err");
        console.error(e);
      }
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      const firstDay = new Date(year, month, 1);
      const startDay = (firstDay.getDay() + 6) % 7; // Monday=0
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      monthLabel.textContent = firstDay.toLocaleDateString("el-GR", { month: "long", year: "numeric" });

      calendarGrid.innerHTML = "";

      const dayLabels = ["Δ", "Τ", "Τ", "Π", "Π", "Σ", "Κ"];
      dayLabels.forEach((label) => {
        const cell = document.createElement("div");
        cell.className = "calendar-cell header";
        cell.textContent = label;
        calendarGrid.appendChild(cell);
      });

      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement("div");
        empty.className = "calendar-cell empty";
        calendarGrid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        const dateKey = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const dayBookings = bookings.filter((b) => b.date === dateKey);

        cell.className = "calendar-cell";
        if (dayBookings.length) cell.classList.add("has-booking");
        if (selectedDate === dateKey) cell.classList.add("active");

        cell.innerHTML =
          `<span>${day}</span>` +
          (dayBookings.length ? `<div class="badge">${dayBookings.length} ραντεβού</div>` : "");

        cell.addEventListener("click", () => {
          selectedDate = dateKey;
          renderCalendar();
          renderBookingsForDate(dateKey);

          const dateInput = bookingForm.querySelector('input[name="date"]');
          if (dateInput) dateInput.value = dateKey;
        });

        calendarGrid.appendChild(cell);
      }

      if (selectedDate) renderBookingsForDate(selectedDate);
      else bookingList.innerHTML = `<div class="hint">Επιλέξτε ημέρα για να δείτε τις καταχωρήσεις.</div>`;
    }

    function renderBookingsForDate(dateKey) {
      const dayBookings = bookings
        .filter((b) => b.date === dateKey)
        .sort((a, b) => String(a.time).localeCompare(String(b.time)));

      if (!dayBookings.length) {
        bookingList.innerHTML = `<div class="hint">Δεν υπάρχουν καταχωρήσεις για την επιλεγμένη ημέρα.</div>`;
        return;
      }

      bookingList.innerHTML = dayBookings.map((b) => {
        const idText = b.id ? `#${escapeHtml(b.id)}` : "(χωρίς id)";
        return `
          <div class="booking-item" data-id="${escapeHtml(b.id)}">
            <h3>
              <span>${escapeHtml(b.time)} · ${escapeHtml(b.beneficiaryName)} <span class="hint" style="font-weight:700"> ${idText}</span></span>
            </h3>
            <div class="booking-meta">
              <div>Υπηρεσία: ${escapeHtml(b.serviceType)}</div>
              <div>Αίθουσα: ${escapeHtml(b.room)}</div>
              <div>Κλινικός εκπαιδευτής: ${escapeHtml(b.clinician)}</div>
              <div>Email: ${escapeHtml(b.beneficiaryEmail)}</div>
              <div>Τηλέφωνο: ${escapeHtml(b.beneficiaryPhone)}</div>
              ${b.notes ? `<div>Σημειώσεις: ${escapeHtml(b.notes)}</div>` : ""}
            </div>

            <div class="row-actions">
              <button type="button" class="small btn-outline" onclick="openEdit('${escapeHtml(b.id)}')">Αλλαγή ώρας/ημ.</button>
              <button type="button" class="small btn-danger" onclick="deleteBooking('${escapeHtml(b.id)}')">Διαγραφή</button>
            </div>
          </div>
        `;
      }).join("");
    }

    // ---------- CRUD actions ----------
    async function addBooking(data) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "add");
      Object.entries(data).forEach(([k,v]) => u.searchParams.set(k, v ?? ""));
      return await jsonp(u.toString());
    }

    async function updateBooking(id, patch) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "update");
      u.searchParams.set("id", id);
      Object.entries(patch).forEach(([k,v]) => u.searchParams.set(k, v ?? ""));
      return await jsonp(u.toString());
    }

    async function removeBooking(id) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "delete");
      u.searchParams.set("id", id);
      return await jsonp(u.toString());
    }

    // expose globally for inline onclick
    window.openEdit = (id) => {
      const cleanId = String(id ?? "").trim();
      const item = bookings.find(x => String(x.id) === cleanId);
      if (!cleanId) {
        alert("Αυτό το ραντεβού δεν έχει id στο sheet, άρα δεν μπορεί να γίνει αλλαγή/διαγραφή. Βάλε id στη γραμμή του sheet.");
        return;
      }
      if (!item) {
        alert("Δεν βρέθηκε το ραντεβού. Κάνε Ανανέωση.");
        return;
      }

      editingId = cleanId;
      editDate.value = item.date || "";
      editTime.value = item.time || "";
      modalInfo.textContent = `Ραντεβού: ${item.beneficiaryName} (${cleanId})`;
      setStatus(modalStatus, "", null);

      modalBackdrop.style.display = "flex";
    };

    window.deleteBooking = async (id) => {
      const cleanId = String(id ?? "").trim();
      if (!cleanId) {
        alert("Αυτό το ραντεβού δεν έχει id στο sheet, άρα δεν μπορεί να γίνει διαγραφή. Βάλε id στη γραμμή του sheet.");
        return;
      }
      if (!confirm(`Διαγραφή ραντεβού #${cleanId};`)) return;

      try {
        const res = await removeBooking(cleanId);
        if (!res?.ok) throw new Error(res?.error || "Delete failed");
        await loadBookings();
      } catch (e) {
        alert("Σφάλμα διαγραφής: " + (e?.message || e));
        console.error(e);
      }
    };

    modalCancel.addEventListener("click", () => {
      modalBackdrop.style.display = "none";
      editingId = null;
    });

    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) {
        modalBackdrop.style.display = "none";
        editingId = null;
      }
    });

    modalSave.addEventListener("click", async () => {
      if (!editingId) return;

      const newDate = (editDate.value || "").trim();
      const newTime = (editTime.value || "").trim();

      if (!newDate || !newTime) {
        setStatus(modalStatus, "❌ Συμπλήρωσε ημερομηνία και ώρα.", "err");
        return;
      }

      setStatus(modalStatus, "Αποθήκευση…", null);
      modalSave.disabled = true;

      try {
        const res = await updateBooking(editingId, { date: newDate, time: newTime });
        if (!res?.ok) throw new Error(res?.error || "Update failed");

        setStatus(modalStatus, "✅ Έγινε η αλλαγή.", "ok");
        await loadBookings();

        // keep selection
        if (selectedDate) renderBookingsForDate(selectedDate);

        setTimeout(() => {
          modalBackdrop.style.display = "none";
          editingId = null;
        }, 450);
      } catch (e) {
        setStatus(modalStatus, "❌ " + (e?.message || e), "err");
        console.error(e);
      } finally {
        modalSave.disabled = false;
      }
    });
    // ----------------------------------

    bookingForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus(formStatus, "Αποθήκευση…", null);
      saveBtn.disabled = true;

      const data = Object.fromEntries(new FormData(event.target).entries());

      try {
        const res = await addBooking(data);
        if (!res?.ok) throw new Error(res?.error || "Σφάλμα αποθήκευσης");
        setStatus(formStatus, "✅ Η καταχώρηση αποθηκεύτηκε.", "ok");
        event.target.reset();
        await loadBookings();
      } catch (e) {
        setStatus(formStatus, "❌ " + (e?.message || e), "err");
        console.error(e);
      } finally {
        saveBtn.disabled = false;
      }
    });

    prevMonth.addEventListener("click", () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
    });

    nextMonth.addEventListener("click", () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
    });

    refreshBtn.addEventListener("click", loadBookings);

    // initial load
    loadBookings();
  </script>
</body>
</html>