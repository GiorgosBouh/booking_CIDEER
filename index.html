<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ΚΕΔΕΕΑ – Booking Calendar</title>

  <style>
    :root{
      color-scheme: light;
      --bg:#f5f7fb;
      --card:#ffffff;
      --primary:#2b59c3;
      --primary-dark:#1e3f8c;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e2e8f0;
      --accent:#f97316;
      --danger:#dc2626;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Inter","Segoe UI",system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:linear-gradient(120deg,#1d4ed8,#4338ca);
      color:#fff;
      padding:28px 20px;
    }
    header h1{margin:0 0 6px;font-size:26px}
    header p{margin:0;opacity:.9}

    main{
      max-width:1100px;
      margin:18px auto 40px;
      padding:0 20px;
      display:grid;
      gap:20px;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      align-items:start;
    }
    main > * { min-width: 0; }

    .card{
      background:var(--card);
      border-radius:18px;
      padding:20px;
      box-shadow:0 16px 30px rgba(15,23,42,.08);
      border:1px solid var(--border);
      overflow:hidden;
    }
    .card h2{margin:0 0 8px;font-size:20px}

    label{display:block;margin-top:12px;font-weight:600}
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      margin-top:6px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
    }

    button{
      margin-top:16px;
      padding:12px 16px;
      border:none;
      border-radius:12px;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      transition:transform .2s ease, background .2s ease;
    }
    button:hover{background:var(--primary-dark);transform:translateY(-1px)}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .btn-outline{
      background:transparent;
      color:var(--primary);
      border:1px solid var(--border);
      padding:10px 12px;
    }
    .btn-danger{ background:var(--danger); }
    .btn-danger:hover{ background:#b91c1c; }

    .grid-2{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .status{margin-top:12px;font-weight:800}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}

    .privacy{
      background:rgba(15,23,42,.04);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      color:var(--muted);
      margin-top:10px;
    }

    .calendar-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .calendar-header .nav{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .calendar-header .nav button{
      margin:0;
      background:transparent;
      color:var(--primary);
      border:1px solid var(--border);
      padding:6px 10px;
    }

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:6px;
      text-align:center;
      font-size:13px;
      width:100%;
      max-width:100%;
    }
    .calendar-cell{
      padding:10px 6px;
      border-radius:10px;
      border:1px solid transparent;
      background:#f8fafc;
      min-height:58px;
      cursor:pointer;
      user-select:none;
      min-width:0;
    }
    .calendar-cell.header{
      background:transparent;
      border:none;
      cursor:default;
      font-weight:900;
      min-height:auto;
      padding:6px 0;
    }
    .calendar-cell.empty{
      background:transparent;
      border:none;
      cursor:default;
    }
    .calendar-cell.active{
      border-color:var(--primary);
      background:rgba(43,89,195,.12);
    }
    .calendar-cell.has-booking{
      background:rgba(249,115,22,.12);
      border-color:rgba(249,115,22,.3);
    }
    .calendar-cell span{
      display:block;
      font-weight:800;
      margin-bottom:4px;
      font-variant-numeric: tabular-nums;
    }

    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(43,89,195,.1);
      color:var(--primary);
      font-size:12px;
      font-weight:800;
      max-width:100%;
      white-space:nowrap;
    }

    .booking-list{display:grid;gap:12px;margin-top:12px}
    .booking-item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      background:#fff;
    }
    .booking-item h3{
      margin:0 0 6px;
      font-size:16px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .booking-meta{display:grid;gap:4px;font-size:13px;color:var(--muted)}
    .row-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .small{
      margin-top:0;
      padding:8px 10px;
      border-radius:10px;
      font-weight:800;
      font-size:13px;
    }

    .chip{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(249,115,22,.12);
      border:1px solid rgba(249,115,22,.25);
      color:#9a3412;
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 24px 60px rgba(15,23,42,.22);
      padding:16px;
    }
    .modal h3{ margin:0 0 10px; }
    .modal .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .radio-row{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      margin-top:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#f8fafc;
    }
    .radio-row label{
      margin:0;
      font-weight:800;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .radio-row input{ width:auto; margin:0; }
  </style>
</head>

<body>
  <header>
    <h1>ΚΕΔΕΕΑ – Booking Calendar</h1>
    <p>Κοινό ημερολόγιο για όλους τους κλινικούς εκπαιδευτές.</p>
    <p><em>Developed by Georgios Bouchouras</em></p>
  </header>

  <main>
    <section class="card">
      <h2>Πρόσβαση</h2>

      <label for="accessToken">Κωδικός πρόσβασης</label>
      <input id="accessToken" type="password" placeholder="Εισάγετε τον κωδικό" autocomplete="current-password" />

      <div class="hint">Ο κωδικός απαιτείται για προβολή/καταχώρηση. </div>
      <div class="privacy">
        Τα στοιχεία προστατεύονται με ιδιωτικό κωδικό πρόσβασης. Μοιράστε τον μόνο με τους εξουσιοδοτημένους κλινικούς εκπαιδευτές.
      </div>

      <button type="button" id="refreshBtn">Φόρτωση / Ανανέωση</button>
      <div class="status" id="authStatus"></div>
    </section>

    <section class="card">
      <h2>Νέα καταχώρηση</h2>

      <form id="bookingForm">
        <label>Ονοματεπώνυμο ωφελούμενου</label>
        <input name="beneficiaryName" required />

        <div class="grid-2">
          <div>
            <label>Email ωφελούμενου</label>
            <input name="beneficiaryEmail" type="email" required />
          </div>
          <div>
            <label>Τηλέφωνο ωφελούμενου</label>
            <input name="beneficiaryPhone" type="tel" required />
          </div>
        </div>

        <label>Είδος υπηρεσίας</label>
        <select name="serviceType" required>
          <option value="">Επιλέξτε υπηρεσία</option>
          <option>Συμβουλευτική</option>
          <option>Αξιολόγηση</option>
          <option>Παρέμβαση</option>
          <option>Άλλο</option>
        </select>

        <div class="grid-2">
          <div>
            <label>Ημερομηνία (Start)</label>
            <input name="date" type="date" required />
          </div>
          <div>
            <label>Ώρα (24ωρη)</label>
            <input name="time" type="time" required />
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label>Αίθουσα</label>
            <input name="room" required />
          </div>
          <div>
            <label>Κλινικός εκπαιδευτής</label>
            <input name="clinician" required />
          </div>
        </div>

        <!-- NEW: Weekly repeat -->
        <div class="radio-row" style="margin-top:14px">
          <label><input type="checkbox" id="repeatWeekly" /> Επανάληψη κάθε εβδομάδα</label>
          <div style="flex:1; min-width:200px">
            <label style="margin:0">End date (μόνο αν είναι εβδομαδιαίο)</label>
            <input id="repeatEndDate" type="date" disabled />
            <div class="hint" style="margin-top:6px">Ορίζει πότε σταματάει η επανάληψη.</div>
          </div>
        </div>

        <label>Σημειώσεις (προαιρετικό)</label>
        <textarea name="notes" rows="3" placeholder="Π.χ. επιπλέον πληροφορίες"></textarea>

        <button type="submit" id="saveBtn">Καταχώρηση</button>
        <div class="status" id="formStatus"></div>
      </form>
    </section>

    <section class="card">
      <div class="calendar-header">
        <div>
          <h2 style="margin:0">Ημερολόγιο</h2>
          <div class="hint" id="monthLabel" style="margin-top:6px"></div>
        </div>
        <div class="nav">
          <button type="button" id="prevMonth">◀</button>
          <button type="button" id="nextMonth">▶</button>
        </div>
      </div>

      <div class="calendar-grid" id="calendarGrid"></div>
      <div class="booking-list" id="bookingList"></div>
    </section>
  </main>

  <!-- Modal for edit -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3>Επεξεργασία ραντεβού</h3>
      <div class="hint" id="modalInfo"></div>

      <!-- NEW: scope only for recurring -->
      <div class="radio-row" id="editScopeRow" style="display:none">
        <label><input type="radio" name="editScope" value="occurrence" checked> Μόνο αυτή η ημέρα</label>
        <label><input type="radio" name="editScope" value="series"> Όλη η σειρά</label>
      </div>

      <div class="grid-2" style="margin-top:10px">
        <div>
          <label>Ημερομηνία</label>
          <input id="editDate" type="date" />
        </div>
        <div>
          <label>Ώρα (24ωρη)</label>
          <input id="editTime" type="time" />
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-outline" id="modalCancel">Άκυρο</button>
        <button type="button" class="btn-danger" id="modalCancelOne" style="display:none">Ακύρωση μόνο αυτής της ημέρας</button>
        <button type="button" id="modalSave">Αποθήκευση αλλαγής</button>
      </div>

      <div class="status" id="modalStatus"></div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYrJR-YjFahtcPheLFFw3s9ZNBc5wIpC4Aq-suTCu83F0agpGFyVvJ-L52SYZnyYK4/exec";
    const TZ = "Europe/Athens";

    const accessTokenInput = document.getElementById("accessToken");
    const authStatus = document.getElementById("authStatus");
    const refreshBtn = document.getElementById("refreshBtn");

    const bookingForm = document.getElementById("bookingForm");
    const formStatus = document.getElementById("formStatus");
    const saveBtn = document.getElementById("saveBtn");

    const calendarGrid = document.getElementById("calendarGrid");
    const bookingList = document.getElementById("bookingList");
    const monthLabel = document.getElementById("monthLabel");
    const prevMonth = document.getElementById("prevMonth");
    const nextMonth = document.getElementById("nextMonth");

    // NEW: repeat controls
    const repeatWeeklyEl = document.getElementById("repeatWeekly");
    const repeatEndDateEl = document.getElementById("repeatEndDate");

    // modal
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalCancel = document.getElementById("modalCancel");
    const modalSave = document.getElementById("modalSave");
    const modalCancelOne = document.getElementById("modalCancelOne");
    const modalStatus = document.getElementById("modalStatus");
    const modalInfo = document.getElementById("modalInfo");
    const editDate = document.getElementById("editDate");
    const editTime = document.getElementById("editTime");
    const editScopeRow = document.getElementById("editScopeRow");

    // DATA:
    let baseRows = [];      // rows from sheet (one row per series)
    let bookings = [];      // expanded occurrences (used for calendar + list)
    let currentMonth = new Date();
    let selectedDate = null;

    // edit state:
    let editing = null; // { id, occurrenceDate, isRecurring }

    // persist token in sessionStorage
    accessTokenInput.value = sessionStorage.getItem("accessToken") || "";
    accessTokenInput.addEventListener("input", () => {
      sessionStorage.setItem("accessToken", accessTokenInput.value.trim());
    });

    // NEW: weekly UI
    repeatWeeklyEl.addEventListener("change", () => {
      repeatEndDateEl.disabled = !repeatWeeklyEl.checked;
      if (!repeatWeeklyEl.checked) repeatEndDateEl.value = "";
    });

    function setStatus(el, msg, kind) {
      el.textContent = msg || "";
      el.classList.remove("ok", "err");
      if (kind === "ok") el.classList.add("ok");
      if (kind === "err") el.classList.add("err");
    }

    function token() {
      return accessTokenInput.value.trim();
    }

    // ---------- Timezone-safe normalize (Athens, 24h) ----------
    function partsInAthens(dateObj) {
      const dtf = new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
      const parts = dtf.formatToParts(dateObj);
      const get = (type) => parts.find(p => p.type === type)?.value || "";
      return { y:get("year"), m:get("month"), d:get("day"), hh:get("hour"), mm:get("minute") };
    }

    function toDateKey(v) {
      if (!v) return "";
      const s = String(v).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(s);
      if (!isNaN(d.getTime())) {
        const p = partsInAthens(d);
        return `${p.y}-${p.m}-${p.d}`;
      }
      return "";
    }

    function toTimeHHMM(v) {
      if (!v) return "";
      const s = String(v).trim();
      if (/^\d{2}:\d{2}$/.test(s)) return s;
      const d = new Date(s);
      if (!isNaN(d.getTime())) {
        const p = partsInAthens(d);
        return `${p.hh}:${p.mm}`;
      }
      return s.slice(0,5);
    }

    function normalizeRows(arr) {
      return (arr || []).map(b => ({
        ...b,
        id: String(b.id ?? "").trim(),
        date: toDateKey(b.date),
        time: toTimeHHMM(b.time),
        beneficiaryPhone: b.beneficiaryPhone != null ? String(b.beneficiaryPhone) : "",
        repeatWeekly: String(b.repeatWeekly ?? "").toUpperCase() === "TRUE" || String(b.repeatWeekly ?? "").toLowerCase() === "true",
        repeatEndDate: toDateKey(b.repeatEndDate),
        exceptions: String(b.exceptions ?? "").trim(), // CSV dates
        overrides: String(b.overrides ?? "").trim()    // JSON
      }));
    }

    function parseExceptions(csv) {
      const s = String(csv || "").trim();
      if (!s) return new Set();
      return new Set(s.split(",").map(x => x.trim()).filter(Boolean));
    }

    function parseOverrides(json) {
      const s = String(json || "").trim();
      if (!s) return {};
      try { return JSON.parse(s); } catch { return {}; }
    }

    function addDays(dateKey, days) {
      const [y,m,d] = dateKey.split("-").map(Number);
      const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0)); // midday UTC avoid DST weirdness
      dt.setUTCDate(dt.getUTCDate() + days);
      const yy = dt.getUTCFullYear();
      const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
      const dd = String(dt.getUTCDate()).padStart(2,"0");
      return `${yy}-${mm}-${dd}`;
    }

    function expandOccurrences(rows) {
      const out = [];
      for (const r of rows) {
        if (!r.id || !r.date || !r.time) continue;

        const base = {
          id: r.id,
          beneficiaryName: r.beneficiaryName,
          beneficiaryEmail: r.beneficiaryEmail,
          beneficiaryPhone: r.beneficiaryPhone,
          serviceType: r.serviceType,
          room: r.room,
          clinician: r.clinician,
          notes: r.notes,
          isRecurring: !!r.repeatWeekly
        };

        if (!r.repeatWeekly || !r.repeatEndDate) {
          out.push({ ...base, date: r.date, time: r.time, occurrenceDate: r.date, isOverride:false });
          continue;
        }

        const exceptions = parseExceptions(r.exceptions);
        const overrides = parseOverrides(r.overrides);

        let d = r.date;
        const end = r.repeatEndDate;
        while (d && d <= end) {
          if (!exceptions.has(d)) {
            const ov = overrides[d] || {};
            out.push({
              ...base,
              date: d,
              occurrenceDate: d,
              time: ov.time ? toTimeHHMM(ov.time) : r.time,
              room: ov.room ?? r.room,
              clinician: ov.clinician ?? r.clinician,
              serviceType: ov.serviceType ?? r.serviceType,
              notes: ov.notes ?? r.notes,
              isOverride: !!overrides[d]
            });
          }
          d = addDays(d, 7);
        }
      }
      return out;
    }
    // ----------------------------------------------------------

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const u = new URL(url);
        u.searchParams.set("callback", cb);

        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };

        const script = document.createElement("script");
        script.src = u.toString();
        script.onerror = () => {
          delete window[cb];
          script.remove();
          reject(new Error("JSONP load failed"));
        };
        document.body.appendChild(script);
      });
    }

    async function loadBookings() {
      setStatus(authStatus, "Φόρτωση…", null);

      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "list");

      try {
        const res = await jsonp(u.toString());
        if (!res?.ok) {
          baseRows = [];
          bookings = [];
          renderCalendar();
          setStatus(authStatus, "❌ Μη έγκυρος κωδικός ή σφάλμα.", "err");
          return;
        }

        baseRows = normalizeRows(res.data);
        bookings = expandOccurrences(baseRows);

        setStatus(authStatus, "✅ Πρόσβαση επιβεβαιώθηκε. Το ημερολόγιο φορτώθηκε.", "ok");
        renderCalendar();
      } catch (e) {
        baseRows = [];
        bookings = [];
        renderCalendar();
        setStatus(authStatus, "⚠️ Δεν ήταν δυνατή η φόρτωση (δες Console).", "err");
        console.error(e);
      }
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      const firstDay = new Date(year, month, 1);
      const startDay = (firstDay.getDay() + 6) % 7; // Monday=0
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      monthLabel.textContent = firstDay.toLocaleDateString("el-GR", { month: "long", year: "numeric" });

      calendarGrid.innerHTML = "";

      const dayLabels = ["Δ", "Τ", "Τ", "Π", "Π", "Σ", "Κ"];
      dayLabels.forEach((label) => {
        const cell = document.createElement("div");
        cell.className = "calendar-cell header";
        cell.textContent = label;
        calendarGrid.appendChild(cell);
      });

      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement("div");
        empty.className = "calendar-cell empty";
        calendarGrid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        const dateKey = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const dayBookings = bookings.filter((b) => b.date === dateKey);

        cell.className = "calendar-cell";
        if (dayBookings.length) cell.classList.add("has-booking");
        if (selectedDate === dateKey) cell.classList.add("active");

        cell.innerHTML =
          `<span>${day}</span>` +
          (dayBookings.length ? `<div class="badge">${dayBookings.length} ραντεβού</div>` : "");

        cell.addEventListener("click", () => {
          selectedDate = dateKey;
          renderCalendar();
          renderBookingsForDate(dateKey);

          const dateInput = bookingForm.querySelector('input[name="date"]');
          if (dateInput) dateInput.value = dateKey;
        });

        calendarGrid.appendChild(cell);
      }

      if (selectedDate) renderBookingsForDate(selectedDate);
      else bookingList.innerHTML = `<div class="hint">Επιλέξτε ημέρα για να δείτε τις καταχωρήσεις.</div>`;
    }

    function renderBookingsForDate(dateKey) {
      const dayBookings = bookings
        .filter((b) => b.date === dateKey)
        .sort((a, b) => String(a.time).localeCompare(String(b.time)));

      if (!dayBookings.length) {
        bookingList.innerHTML = `<div class="hint">Δεν υπάρχουν καταχωρήσεις για την επιλεγμένη ημέρα.</div>`;
        return;
      }

      bookingList.innerHTML = dayBookings.map((b) => {
        const idText = b.id ? `#${escapeHtml(b.id)}` : "(χωρίς id)";
        const rep = b.isRecurring ? `<span class="chip">weekly</span>` : "";
        const ov = b.isOverride ? `<span class="chip">edited day</span>` : "";

        return `
          <div class="booking-item">
            <h3>
              <span>${escapeHtml(b.time)} · ${escapeHtml(b.beneficiaryName)} ${rep} ${ov}
                <span class="hint" style="font-weight:700"> ${idText}</span>
              </span>
            </h3>

            <div class="booking-meta">
              <div>Ημερομηνία: ${escapeHtml(b.date)}</div>
              <div>Υπηρεσία: ${escapeHtml(b.serviceType)}</div>
              <div>Αίθουσα: ${escapeHtml(b.room)}</div>
              <div>Κλινικός εκπαιδευτής: ${escapeHtml(b.clinician)}</div>
              <div>Email: ${escapeHtml(b.beneficiaryEmail)}</div>
              <div>Τηλέφωνο: ${escapeHtml(b.beneficiaryPhone)}</div>
              ${b.notes ? `<div>Σημειώσεις: ${escapeHtml(b.notes)}</div>` : ""}
            </div>

            <div class="row-actions">
              <button type="button" class="small btn-outline" onclick="openEdit('${escapeHtml(b.id)}','${escapeHtml(b.occurrenceDate)}',${b.isRecurring ? "true" : "false"})">
                Αλλαγή ώρας/ημ.
              </button>

              ${b.isRecurring ? `
                <button type="button" class="small btn-danger" onclick="cancelOne('${escapeHtml(b.id)}','${escapeHtml(b.occurrenceDate)}')">
                  Ακύρωση μόνο αυτής της ημέρας
                </button>
                <button type="button" class="small btn-danger" onclick="deleteSeries('${escapeHtml(b.id)}')">
                  Διαγραφή σειράς
                </button>
              ` : `
                <button type="button" class="small btn-danger" onclick="deleteSeries('${escapeHtml(b.id)}')">
                  Διαγραφή
                </button>
              `}
            </div>
          </div>
        `;
      }).join("");
    }

    // ---------- CRUD actions ----------
    async function addBooking(data) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "add");
      Object.entries(data).forEach(([k,v]) => u.searchParams.set(k, v ?? ""));
      return await jsonp(u.toString());
    }

    async function updateSeries(id, patch) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "update");
      u.searchParams.set("id", id);
      Object.entries(patch).forEach(([k,v]) => u.searchParams.set(k, v ?? ""));
      return await jsonp(u.toString());
    }

    async function updateOccurrence(id, occurrenceDate, patch) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "update_occurrence");
      u.searchParams.set("id", id);
      u.searchParams.set("occurrenceDate", occurrenceDate);
      Object.entries(patch).forEach(([k,v]) => u.searchParams.set(k, v ?? ""));
      return await jsonp(u.toString());
    }

    async function cancelOccurrence(id, occurrenceDate) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "cancel_occurrence");
      u.searchParams.set("id", id);
      u.searchParams.set("occurrenceDate", occurrenceDate);
      return await jsonp(u.toString());
    }

    async function removeSeries(id) {
      const u = new URL(SCRIPT_URL);
      u.searchParams.set("token", token());
      u.searchParams.set("action", "delete");
      u.searchParams.set("id", id);
      return await jsonp(u.toString());
    }

    // expose globally for inline onclick
    window.openEdit = (id, occurrenceDate, isRecurring) => {
      const cleanId = String(id ?? "").trim();
      const occ = String(occurrenceDate ?? "").trim();

      if (!cleanId) {
        alert("Αυτό το ραντεβού δεν έχει id στο sheet, άρα δεν μπορεί να γίνει αλλαγή/διαγραφή.");
        return;
      }

      editing = { id: cleanId, occurrenceDate: occ, isRecurring: !!isRecurring };

      editDate.value = occ || "";
      const item = bookings.find(x => x.id === cleanId && x.occurrenceDate === occ);
      editTime.value = item?.time || "";

      modalInfo.textContent = editing.isRecurring
        ? `Επαναλαμβανόμενο ραντεβού (${cleanId}) – ημέρα: ${occ}`
        : `Ραντεβού (${cleanId})`;

      setStatus(modalStatus, "", null);

      editScopeRow.style.display = editing.isRecurring ? "flex" : "none";
      modalCancelOne.style.display = editing.isRecurring ? "inline-block" : "none";

      if (editing.isRecurring) {
        document.querySelector('input[name="editScope"][value="occurrence"]').checked = true;
      }

      modalBackdrop.style.display = "flex";
    };

    window.cancelOne = async (id, occurrenceDate) => {
      const cleanId = String(id ?? "").trim();
      const occ = String(occurrenceDate ?? "").trim();
      if (!confirm(`Ακύρωση μόνο για ${occ} (σειρά #${cleanId});`)) return;

      try {
        const res = await cancelOccurrence(cleanId, occ);
        if (!res?.ok) throw new Error(res?.error || "Cancel failed");
        await loadBookings();
      } catch (e) {
        alert("Σφάλμα ακύρωσης: " + (e?.message || e));
        console.error(e);
      }
    };

    window.deleteSeries = async (id) => {
      const cleanId = String(id ?? "").trim();
      if (!cleanId) {
        alert("Δεν υπάρχει id.");
        return;
      }
      if (!confirm(`Διαγραφή ${cleanId}; (Αν είναι σειρά, θα διαγραφεί όλη)`)) return;

      try {
        const res = await removeSeries(cleanId);
        if (!res?.ok) throw new Error(res?.error || "Delete failed");
        await loadBookings();
      } catch (e) {
        alert("Σφάλμα διαγραφής: " + (e?.message || e));
        console.error(e);
      }
    };

    modalCancel.addEventListener("click", () => {
      modalBackdrop.style.display = "none";
      editing = null;
    });

    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) {
        modalBackdrop.style.display = "none";
        editing = null;
      }
    });

    modalCancelOne.addEventListener("click", async () => {
      if (!editing?.id || !editing?.occurrenceDate) return;
      if (!confirm(`Ακύρωση μόνο για ${editing.occurrenceDate};`)) return;

      setStatus(modalStatus, "Ακύρωση…", null);
      modalCancelOne.disabled = true;

      try {
        const res = await cancelOccurrence(editing.id, editing.occurrenceDate);
        if (!res?.ok) throw new Error(res?.error || "Cancel failed");
        setStatus(modalStatus, "✅ Ακυρώθηκε μόνο αυτή η ημέρα.", "ok");
        await loadBookings();

        setTimeout(() => {
          modalBackdrop.style.display = "none";
          editing = null;
        }, 450);
      } catch (e) {
        setStatus(modalStatus, "❌ " + (e?.message || e), "err");
        console.error(e);
      } finally {
        modalCancelOne.disabled = false;
      }
    });

    modalSave.addEventListener("click", async () => {
      if (!editing?.id) return;

      const newDate = (editDate.value || "").trim();
      const newTime = (editTime.value || "").trim();

      if (!newDate || !newTime) {
        setStatus(modalStatus, "❌ Συμπλήρωσε ημερομηνία και ώρα.", "err");
        return;
      }

      setStatus(modalStatus, "Αποθήκευση…", null);
      modalSave.disabled = true;

      try {
        if (!editing.isRecurring) {
          const res = await updateSeries(editing.id, { date: newDate, time: newTime });
          if (!res?.ok) throw new Error(res?.error || "Update failed");
          setStatus(modalStatus, "✅ Έγινε η αλλαγή.", "ok");
          await loadBookings();
        } else {
          const scope = document.querySelector('input[name="editScope"]:checked')?.value || "occurrence";

          if (scope === "series") {
            const res = await updateSeries(editing.id, { date: newDate, time: newTime });
            if (!res?.ok) throw new Error(res?.error || "Update failed");
            setStatus(modalStatus, "✅ Έγινε η αλλαγή σε όλη τη σειρά.", "ok");
            await loadBookings();
          } else {
            if (newDate !== editing.occurrenceDate) {
              throw new Error("Για αλλαγή ημερομηνίας σε επαναλαμβανόμενο: ακύρωσε τη μέρα και βάλε νέο ραντεβού. (Μπορώ να στο προσθέσω αν το θες.)");
            }
            const res = await updateOccurrence(editing.id, editing.occurrenceDate, { time: newTime });
            if (!res?.ok) throw new Error(res?.error || "Update occurrence failed");
            setStatus(modalStatus, "✅ Έγινε η αλλαγή μόνο για αυτή την ημέρα.", "ok");
            await loadBookings();
          }
        }

        if (selectedDate) renderBookingsForDate(selectedDate);

        setTimeout(() => {
          modalBackdrop.style.display = "none";
          editing = null;
        }, 450);
      } catch (e) {
        setStatus(modalStatus, "❌ " + (e?.message || e), "err");
        console.error(e);
      } finally {
        modalSave.disabled = false;
      }
    });

    bookingForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus(formStatus, "Αποθήκευση…", null);
      saveBtn.disabled = true;

      const data = Object.fromEntries(new FormData(event.target).entries());

      // NEW: weekly params
      if (repeatWeeklyEl.checked) {
        const end = (repeatEndDateEl.value || "").trim();
        if (!end) {
          setStatus(formStatus, "❌ Βάλε End date για εβδομαδιαία επανάληψη.", "err");
          saveBtn.disabled = false;
          return;
        }
        data.repeatWeekly = "true";
        data.repeatEndDate = end;
      }

      try {
        const res = await addBooking(data);
        if (!res?.ok) throw new Error(res?.error || "Σφάλμα αποθήκευσης");

        setStatus(formStatus, "✅ Η καταχώρηση αποθηκεύτηκε.", "ok");
        event.target.reset();

        // reset weekly UI
        repeatWeeklyEl.checked = false;
        repeatEndDateEl.value = "";
        repeatEndDateEl.disabled = true;

        await loadBookings();
      } catch (e) {
        setStatus(formStatus, "❌ " + (e?.message || e), "err");
        console.error(e);
      } finally {
        saveBtn.disabled = false;
      }
    });

    prevMonth.addEventListener("click", () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
    });

    nextMonth.addEventListener("click", () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
    });

    refreshBtn.addEventListener("click", loadBookings);

    // initial load
    loadBookings();
  </script>
</body>
</html>